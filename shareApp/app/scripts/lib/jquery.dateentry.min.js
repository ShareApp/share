/* http://keith-wood.name/dateEntry.html
   Date entry for jQuery v1.1.1.
   Written by Keith Wood (kbwood{at}iinet.com.au) March 2009.
   Licensed under the MIT (https://github.com/jquery/jquery/blob/master/MIT-LICENSE.txt) license.
   Please attribute the author if you use it. */
(function($){function DateEntry(){this._disabledInputs=[];this.regional=[];this.regional['']={dateFormat:'mdy/',monthNames:['January','February','March','April','May','June','July','August','September','October','November','December'],monthNamesShort:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],dayNames:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],dayNamesShort:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],spinnerTexts:['Today','Previous field','Next field','Increment','Decrement']};this._defaults={appendText:'',initialField:0,useMouseWheel:true,defaultDate:null,minDate:null,maxDate:null,spinnerImage:'spinnerDefault.png',spinnerSize:[20,20,8],spinnerBigImage:'',spinnerBigSize:[40,40,16],spinnerIncDecOnly:false,spinnerRepeat:[500,250],beforeShow:null,altField:null,altFormat:null};$.extend(this._defaults,this.regional[''])}$.extend(DateEntry.prototype,{markerClassName:'hasDateEntry',propertyName:'dateEntry',_appendClass:'dateEntry_append',_controlClass:'dateEntry_control',_expandClass:'dateEntry_expand',setDefaults:function(a){$.extend(this._defaults,a||{});return this},_attachPlugin:function(b,c){var d=$(b);if(d.hasClass(this.markerClassName)){return}var e={options:$.extend({},this._defaults,c),input:d,_field:0,_selectedYear:0,_selectedMonth:0,_selectedDay:0};d.data(this.propertyName,e).addClass(this.markerClassName).bind('focus.'+this.propertyName,this._doFocus).bind('blur.'+this.propertyName,this._doBlur).bind('click.'+this.propertyName,this._doClick).bind('keydown.'+this.propertyName,this._doKeyDown).bind('keypress.'+this.propertyName,this._doKeyPress).bind('paste.'+this.propertyName,function(a){setTimeout(function(){m._parseDate(e)},1)});this._optionPlugin(b,c)},_optionPlugin:function(a,b,c){a=$(a);var d=a.data(this.propertyName);if(!b||(typeof b=='string'&&c==null)){var e=b;b=(d||{}).options;return(b&&e?b[e]:b)}if(!a.hasClass(this.markerClassName)){return}b=b||{};if(typeof b=='string'){var e=b;b={};b[e]=c}var f=this._extractDate(a.val(),d);$.extend(d.options,b);d._field=0;if(f){this._setDate(d,f)}a.next('span.'+this._appendClass).remove();a.parent().find('span.'+this._controlClass).remove();if($.fn.mousewheel){a.unmousewheel()}var g=(!d.options.spinnerImage?null:$('<span class="'+this._controlClass+'" style="display: inline-block; '+'background: url(\''+d.options.spinnerImage+'\') 0 0 no-repeat; width: '+d.options.spinnerSize[0]+'px; height: '+d.options.spinnerSize[1]+'px;"></span>'));a.after(d.options.appendText?'<span class="'+this._appendClass+'">'+d.options.appendText+'</span>':'').after(g||'');if(d.options.useMouseWheel&&$.fn.mousewheel){a.mousewheel(this._doMouseWheel)}if(g){g.mousedown(this._handleSpinner).mouseup(this._endSpinner).mouseover(this._expandSpinner).mouseout(this._endSpinner).mousemove(this._describeSpinner)}},_enablePlugin:function(a){this._enableDisable(a,false)},_disablePlugin:function(a){this._enableDisable(a,true)},_enableDisable:function(b,c){var d=$.data(b,this.propertyName);if(!d){return}b.disabled=c;if(b.nextSibling&&b.nextSibling.nodeName.toLowerCase()=='span'){m._changeSpinner(d,b.nextSibling,(c?5:-1))}m._disabledInputs=$.map(m._disabledInputs,function(a){return(a==b?null:a)});if(c){m._disabledInputs.push(b)}},_isDisabledPlugin:function(a){return $.inArray(a,this._disabledInputs)>-1},_destroyPlugin:function(b){b=$(b);if(!b.hasClass(this.markerClassName)){return}b.removeClass(this.markerClassName).removeData(this.propertyName).unbind('.'+this.propertyName);if($.fn.mousewheel){b.unmousewheel()}this._disabledInputs=$.map(this._disabledInputs,function(a){return(a==b[0]?null:a)});b.siblings('.'+this._appendClass+',.'+this._controlClass).remove()},_setDatePlugin:function(a,b){var c=$.data(a,this.propertyName);if(c){if(b===null||b===''){c.input.val('')}else{this._setDate(c,b?(typeof b=='object'?new Date(b.getTime()):b):null)}}},_getDatePlugin:function(a){var b=$.data(a,this.propertyName);return(b?this._extractDate(b.input.val(),b):null)},_doFocus:function(a){var b=(a.nodeName&&a.nodeName.toLowerCase()=='input'?a:this);if(m._lastInput==b||m._isDisabledPlugin(b)){m._focussed=false;return}var c=$.data(b,m.propertyName);m._focussed=true;m._lastInput=b;m._blurredInput=null;$.extend(c.options,($.isFunction(c.options.beforeShow)?c.options.beforeShow.apply(b,[b]):{}));m._parseDate(c);setTimeout(function(){m._showField(c)},10)},_doBlur:function(a){m._blurredInput=m._lastInput;m._lastInput=null},_doClick:function(b){var c=b.target;var d=$.data(c,m.propertyName);if(!m._focussed){d._field=0;if(c.selectionStart!=null){var e=0;for(var f=0;f<3;f++){e+=m._fieldLength(d,f,d.options.dateFormat)+1;d._field=f;if(c.selectionStart<e){break}}}else if(c.createTextRange){var g=$(b.srcElement);var h=c.createTextRange();var i=function(a){return{thin:2,medium:4,thick:6}[a]||a};var j=b.clientX+document.documentElement.scrollLeft-(g.offset().left+parseInt(i(g.css('border-left-width')),10))-h.offsetLeft;var e=0;for(var f=0;f<3;f++){e+=m._fieldLength(d,f,d.options.dateFormat)+1;h.collapse();h.moveEnd('character',e);d._field=f;if(j<h.boundingWidth){break}}}}m._showField(d);m._focussed=false},_doKeyDown:function(a){if(a.keyCode>=48){return true}var b=$.data(a.target,m.propertyName);switch(a.keyCode){case 9:return(a.shiftKey?m._changeField(b,-1,true):m._changeField(b,+1,true));case 35:if(a.ctrlKey){m._setValue(b,'')}else{b._field=2;m._adjustField(b,0)}break;case 36:if(a.ctrlKey){m._setDate(b)}else{b._field=0;m._adjustField(b,0)}break;case 37:m._changeField(b,-1,false);break;case 38:m._adjustField(b,+1);break;case 39:m._changeField(b,+1,false);break;case 40:m._adjustField(b,-1);break;case 46:m._setValue(b,'');break;default:return true}return false},_doKeyPress:function(a){var b=String.fromCharCode(a.charCode==undefined?a.keyCode:a.charCode);if(b<' '){return true}var c=$.data(a.target,m.propertyName);m._handleKeyPress(c,b);return false},_doMouseWheel:function(a,b){if(m._isDisabledPlugin(a.target)){return}var c=$.data(a.target,m.propertyName);c.input.focus();if(!c.input.val()){m._parseDate(c)}m._adjustField(c,b);a.preventDefault()},_expandSpinner:function(b){var c=m._getSpinnerTarget(b);var d=$.data(m._getInput(c),m.propertyName);if(m._isDisabledPlugin(d.input[0])){return}if(d.options.spinnerBigImage){d._expanded=true;var e=$(c).offset();var f=null;$(c).parents().each(function(){var a=$(this);if(a.css('position')=='relative'||a.css('position')=='absolute'){f=a.offset()}return!f});$('<div class="'+m._expandClass+'" style="position: absolute; left: '+(e.left-(d.options.spinnerBigSize[0]-d.options.spinnerSize[0])/2-(f?f.left:0))+'px; top: '+(e.top-(d.options.spinnerBigSize[1]-d.options.spinnerSize[1])/2-(f?f.top:0))+'px; width: '+d.options.spinnerBigSize[0]+'px; height: '+d.options.spinnerBigSize[1]+'px; background: transparent url('+d.options.spinnerBigImage+') no-repeat 0px 0px; z-index: 10;"></div>').mousedown(m._handleSpinner).mouseup(m._endSpinner).mouseout(m._endExpand).mousemove(m._describeSpinner).insertAfter(c)}},_getInput:function(a){return $(a).siblings('.'+m.markerClassName)[0]},_describeSpinner:function(a){var b=m._getSpinnerTarget(a);var c=$.data(m._getInput(b),m.propertyName);b.title=c.options.spinnerTexts[m._getSpinnerRegion(c,a)]},_handleSpinner:function(a){var b=m._getSpinnerTarget(a);var c=m._getInput(b);if(m._isDisabledPlugin(c)){return}if(c==m._blurredInput){m._lastInput=c;m._blurredInput=null}var d=$.data(c,m.propertyName);m._doFocus(c);var e=m._getSpinnerRegion(d,a);m._changeSpinner(d,b,e);m._actionSpinner(d,e);m._timer=null;m._handlingSpinner=true;if(e>=3&&d.options.spinnerRepeat[0]){m._timer=setTimeout(function(){m._repeatSpinner(d,e)},d.options.spinnerRepeat[0]);$(b).one('mouseout',m._releaseSpinner).one('mouseup',m._releaseSpinner)}},_actionSpinner:function(a,b){if(!a.input.val()){m._parseDate(a)}switch(b){case 0:this._setDate(a);break;case 1:this._changeField(a,-1,false);break;case 2:this._changeField(a,+1,false);break;case 3:this._adjustField(a,+1);break;case 4:this._adjustField(a,-1);break}},_repeatSpinner:function(a,b){if(!m._timer){return}m._lastInput=m._blurredInput;this._actionSpinner(a,b);this._timer=setTimeout(function(){m._repeatSpinner(a,b)},a.options.spinnerRepeat[1])},_releaseSpinner:function(a){clearTimeout(m._timer);m._timer=null},_endExpand:function(a){m._timer=null;var b=m._getSpinnerTarget(a);var c=m._getInput(b);var d=$.data(c,m.propertyName);$(b).remove();d._expanded=false},_endSpinner:function(a){m._timer=null;var b=m._getSpinnerTarget(a);var c=m._getInput(b);var d=$.data(c,m.propertyName);if(!m._isDisabledPlugin(c)){m._changeSpinner(d,b,-1)}if(m._handlingSpinner){m._lastInput=m._blurredInput}if(m._lastInput&&m._handlingSpinner){m._showField(d)}m._handlingSpinner=false},_getSpinnerTarget:function(a){return a.target||a.srcElement},_getSpinnerRegion:function(a,b){var c=this._getSpinnerTarget(b);var d=$(c).offset();var e=[document.documentElement.scrollLeft||document.body.scrollLeft,document.documentElement.scrollTop||document.body.scrollTop];var f=(a.options.spinnerIncDecOnly?99:b.clientX+e[0]-d.left);var g=b.clientY+e[1]-d.top;var h=a.options[a._expanded?'spinnerBigSize':'spinnerSize'];var i=(a.options.spinnerIncDecOnly?99:h[0]-1-f);var j=h[1]-1-g;if(h[2]>0&&Math.abs(f-i)<=h[2]&&Math.abs(g-j)<=h[2]){return 0}var k=Math.min(f,g,i,j);return(k==f?1:(k==i?2:(k==g?3:4)))},_changeSpinner:function(a,b,c){$(b).css('background-position','-'+((c+1)*a.options[a._expanded?'spinnerBigSize':'spinnerSize'][0])+'px 0px')},_parseDate:function(a){var b=this._extractDate(a.input.val(),a)||this._normaliseDate(this._determineDate(a.options.defaultDate,a)||new Date());a._selectedYear=b.getFullYear();a._selectedMonth=b.getMonth();a._selectedDay=b.getDate();a._lastChr='';a._field=Math.max(0,Math.min(2,a.options.initialField));if(a.input.val()!=''){this._showDate(a)}},_extractDate:function(a,b){var c=a.split(new RegExp('[\\'+b.options.dateFormat.substring(3).split('').join('\\')+']'));var d=0;var e=0;var f=0;for(var i=0;i<3;i++){var g=parseInt(c[i],10);g=(isNaN(g)?0:g);var h=b.options.dateFormat.charAt(i);switch(h){case'y':d=g;break;case'Y':d=(g%100)+(new Date().getFullYear()-new Date().getFullYear()%100);break;case'm':e=g;break;case'n':case'N':e=$.inArray(c[i],b.options[h=='N'?'monthNames':'monthNamesShort'])+1;break;case'w':case'W':if(b.options.dateFormat.charAt(3)==' '){c.splice(i,1);g=parseInt(c[i],10)}else{g=parseInt(c[i].replace(/^.* /,''),10)}g=(isNaN(g)?0:g);case'd':f=g;break}}return(d&&e&&f?new Date(d,e-1,f,12):null)},_showDate:function(a){this._setValue(a,this._formatDate(a,a.options.dateFormat));this._showField(a)},_formatDate:function(a,b){var c='';for(var i=0;i<3;i++){c+=(i==0?'':b.charAt(3));var d=b.charAt(i);switch(d){case'y':c+=this._formatNumber(a._selectedYear);break;case'Y':c+=this._formatNumber(a._selectedYear%100);break;case'm':c+=this._formatNumber(a._selectedMonth+1);break;case'n':case'N':c+=a.options[d=='N'?'monthNames':'monthNamesShort'][a._selectedMonth];break;case'd':c+=this._formatNumber(a._selectedDay);break;case'w':case'W':c+=a.options[d=='W'?'dayNames':'dayNamesShort'][new Date(a._selectedYear,a._selectedMonth,a._selectedDay,12).getDay()]+' '+this._formatNumber(a._selectedDay);break}}return c},_showField:function(a){var b=a.input[0];if(a.input.is(':hidden')||m._lastInput!=b){return}var c=0;for(var i=0;i<a._field;i++){c+=this._fieldLength(a,i,a.options.dateFormat)+1}var d=c+this._fieldLength(a,i,a.options.dateFormat);if(b.setSelectionRange){b.setSelectionRange(c,d)}else if(b.createTextRange){var e=b.createTextRange();e.moveStart('character',c);e.moveEnd('character',d-a.input.val().length);e.select()}if(!b.disabled){b.focus()}},_fieldLength:function(a,b,c){b=c.charAt(b);switch(b){case'y':return 4;case'n':case'N':return a.options[b=='N'?'monthNames':'monthNamesShort'][a._selectedMonth].length;case'w':case'W':return a.options[b=='W'?'dayNames':'dayNamesShort'][new Date(a._selectedYear,a._selectedMonth,a._selectedDay,12).getDay()].length+3;default:return 2}},_formatNumber:function(a){return(a<10?'0':'')+a},_setValue:function(a,b){if(b!=a.input.val()){if(a.options.altField){$(a.options.altField).val(!b?'':this._formatDate(a,a.options.altFormat||a.options.dateFormat))}a.input.val(b).trigger('change')}},_changeField:function(a,b,c){var d=(a.input.val()==''||a._field==(b==-1?0:2));if(!d){a._field+=b}this._showField(a);a._lastChr='';return(d&&c)},_adjustField:function(a,b){if(a.input.val()==''){b=0}var c=a.options.dateFormat.charAt(a._field);var d=a._selectedYear+(c=='y'||c=='Y'?b:0);var e=a._selectedMonth+(c=='m'||c=='n'||c=='N'?b:0);var f=(c=='d'||c=='w'||c=='W'?a._selectedDay+b:Math.min(a._selectedDay,this._getDaysInMonth(d,e)));this._setDate(a,new Date(d,e,f,12))},_getDaysInMonth:function(a,b){return new Date(a,b+1,0,12).getDate()},_setDate:function(a,b){b=this._normaliseDate(this._determineDate(b||a.options.defaultDate,a)||new Date());var c=this._normaliseDate(this._determineDate(a.options.minDate,a));var d=this._normaliseDate(this._determineDate(a.options.maxDate,a));b=(c&&b<c?c:(d&&b>d?d:b));a._selectedYear=b.getFullYear();a._selectedMonth=b.getMonth();a._selectedDay=b.getDate();this._showDate(a)},_determineDate:function(h,i){var j=function(a){var b=m._normaliseDate(new Date());b.setDate(b.getDate()+a);return b};var k=function(a){var b=m._extractDate(a,i);if(b){return b}a=a.toLowerCase();b=m._normaliseDate(new Date());var c=b.getFullYear();var d=b.getMonth();var e=b.getDate();var f=/([+-]?[0-9]+)\s*(d|w|m|y)?/g;var g=f.exec(a);while(g){switch(g[2]||'d'){case'd':e+=parseInt(g[1],10);break;case'w':e+=parseInt(g[1],10)*7;break;case'm':d+=parseInt(g[1],10);break;case'y':c+=parseInt(g[1],10);break}g=f.exec(a)}return new Date(c,d,e,12)};return(h?(typeof h=='string'?k(h):(typeof h=='number'?j(h):h)):null)},_normaliseDate:function(a){if(a){a.setHours(12,0,0,0)}return a},_handleKeyPress:function(a,b){if(a.options.dateFormat.substring(3).indexOf(b)>-1){this._changeField(a,+1,false)}else if(b>='0'&&b<='9'){var c=a.options.dateFormat.charAt(a._field);var d=parseInt(b,10);var e=parseInt((a._lastChr||'')+b,10);var f=(c!='y'&&c!='Y'?a._selectedYear:e);var g=(c!='m'&&c!='n'&&c!='N'?a._selectedMonth+1:(e>=1&&e<=12?e:(d>0?d:a._selectedMonth+1)));var h=(c!='d'&&c!='w'&&c!='W'?a._selectedDay:(e>=1&&e<=this._getDaysInMonth(f,g-1)?e:(d>0?d:a._selectedDay)));this._setDate(a,new Date(f,g-1,h,12));a._lastChr=(c!='y'?'':a._lastChr.substr(Math.max(0,a._lastChr.length-2)))+b}else{var c=a.options.dateFormat.charAt(a._field);if(c=='n'||c=='N'){a._lastChr+=b.toLowerCase();var j=a.options[c=='n'?'monthNamesShort':'monthNames'];var k=function(){for(var i=0;i<j.length;i++){if(j[i].toLowerCase().substring(0,a._lastChr.length)==a._lastChr){return i;break}}return-1};var g=k();if(g==-1){a._lastChr=b.toLowerCase();g=k()}if(g==-1){a._lastChr=''}else{var f=a._selectedYear;var h=Math.min(a._selectedDay,this._getDaysInMonth(f,g));this._setDate(a,new Date(f,g,h,12))}}}}});var l=['getDate','isDisabled'];function isNotChained(a,b){if(a=='option'&&(b.length==0||(b.length==1&&typeof b[0]=='string'))){return true}return $.inArray(a,l)>-1}$.fn.dateEntry=function(b){var c=Array.prototype.slice.call(arguments,1);if(isNotChained(b,c)){return m['_'+b+'Plugin'].apply(m,[this[0]].concat(c))}return this.each(function(){if(typeof b=='string'){if(!m['_'+b+'Plugin']){throw'Unknown command: '+b;}m['_'+b+'Plugin'].apply(m,[this].concat(c))}else{var a=($.fn.metadata?$(this).metadata():{});m._attachPlugin(this,$.extend({},a,b||{}))}})};var m=$.dateEntry=new DateEntry()})(jQuery);